<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Quejas</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <meta name="robots" content="noindex, nofollow">

    <style>
        :root {
            --color-primary-dark: #0A1628; --color-primary-blue: #1E3A8A; --color-accent-blue: #3B82F6;
            --color-light-gray: #F3F4F6; --color-text-dark: #1F2937; --color-text-medium: #4B5563;
            --color-border: #E5E7EB; --color-white: #FFFFFF; --color-error: #EF4444; --color-success: #10B981;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-light-gray); color: var(--color-text-dark); margin: 0; }
        .header { background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary-blue) 100%); color: var(--color-white); padding: 20px 40px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-family: 'Montserrat', sans-serif; font-size: 2em; }
        
        /* Estilos para las Pestañas */
        .tabs-nav { display: flex; background-color: var(--color-white); border-bottom: 1px solid var(--color-border); padding: 0 40px; }
        .tab-btn { background: none; border: none; padding: 15px 25px; font-size: 1.1em; font-weight: 600; color: var(--color-text-medium); cursor: pointer; position: relative; transition: color 0.2s ease; }
        .tab-btn::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background-color: var(--color-accent-blue); transform: scaleX(0); transition: transform 0.3s ease; }
        .tab-btn.active { color: var(--color-primary-blue); }
        .tab-btn.active::after { transform: scaleX(1); }

        .dashboard-container { max-width: 1600px; margin: 20px auto; padding: 20px; }
        .quejas-lista { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; }
        .queja-tarjeta { background-color: var(--color-white); border: 1px solid var(--color-border); border-left: 5px solid var(--color-primary-blue); border-radius: 8px; padding: 15px 20px; transition: box-shadow 0.2s ease, transform 0.2s ease; cursor: pointer; }
        .queja-tarjeta:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .tarjeta-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .tarjeta-folio { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1.2em; color: var(--color-primary-blue); }
        .tarjeta-fecha { font-size: 0.85em; color: var(--color-text-medium); }
        .tarjeta-body p { margin: 5px 0; font-size: 0.95em; }
        .empty-state { text-align: center; grid-column: 1 / -1; padding: 50px; font-size: 1.2em; color: var(--color-text-medium); font-style: italic; }
        
        /* Estilos para el Modal de Detalles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 22, 40, 0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--color-white); border-radius: 15px; width: 90%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-family: 'Montserrat', sans-serif; font-size: 1.5em; color: var(--color-primary-blue); }
        .modal-close-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: var(--color-text-medium); }
        .modal-body { padding: 25px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 15px 25px; }
        .detail-item { padding: 10px; background-color: var(--color-light-gray); border-radius: 8px; }
        .detail-item strong { display: block; font-size: 0.8em; text-transform: uppercase; color: var(--color-text-medium); margin-bottom: 5px; }
        .full-width { grid-column: 1 / -1; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--color-border); background-color: var(--color-light-gray); }
        .modal-footer textarea { width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 1em; margin-bottom: 15px; }
        .modal-footer button { background-color: var(--color-success); color: white; border: none; padding: 12px 25px; font-size: 1.1em; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease; }
        .modal-footer button:hover { background-color: #059669; }

    </style>
</head>
<body>

    <header class="header"><h1>Panel de Quejas</h1></header>

    <nav class="tabs-nav" id="tabsNav">
        <button class="tab-btn active" data-tipo="Todos">Todas</button>
        <button class="tab-btn" data-tipo="Retraso">Retrasos</button>
        <button class="tab-btn" data-tipo="Mal trato">Mal Trato</button>
        <button class="tab-btn" data-tipo="Inseguridad">Inseguridad</button>
        <button class="tab-btn" data-tipo="Unidad en mal estado">Mal Estado</button>
        <button class="tab-btn" data-tipo="Otro">Otras</button>
    </nav>

    <main class="dashboard-container">
        <div class="quejas-lista" id="quejasLista">
            </div>
    </main>
    
    <div class="modal-overlay" id="detailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalFolio"></h2>
                <button class="modal-close-btn" id="modalCloseBtn">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                </div>
            <div class="modal-footer">
                <form id="resolveForm">
                    <label for="resolucionText"><strong>Escribir Resolución:</strong></label>
                    <textarea id="resolucionText" placeholder="Describe la acción tomada para resolver esta queja..." required></textarea>
                    <button type="submit">Marcar como Atendida</button>
                </form>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tabsNav = document.getElementById('tabsNav');
        const quejasLista = document.getElementById('quejasLista');
        const detailsModal = document.getElementById('detailsModal');
        const modalFolio = document.getElementById('modalFolio');
        const modalBody = document.getElementById('modalBody');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const resolveForm = document.getElementById('resolveForm');
        
        let todasLasQuejas = [];
        let quejaActual = null; // Guardará la queja que se está viendo en el modal

        /**
         * Pide todas las quejas al servidor.
         */
        async function fetchQuejas() {
            try {
                const response = await fetch('/api/quejas');
                if (!response.ok) throw new Error('Error al cargar datos');
                todasLasQuejas = await response.json();
                renderQuejas(); // Renderiza todas las quejas pendientes por defecto
            } catch (error) {
                quejasLista.innerHTML = `<p class="empty-state">Error al cargar las quejas.</p>`;
                console.error(error);
            }
        }

        /**
         * Muestra las quejas en la pantalla, aplicando el filtro de la pestaña activa.
         */
        function renderQuejas() {
            quejasLista.innerHTML = '';
            const activeTab = document.querySelector('.tab-btn.active');
            const tipoFiltro = activeTab.dataset.tipo;

            const quejasPendientes = todasLasQuejas.filter(q => q.estado_queja === 'Pendiente');
            
            const quejasFiltradas = tipoFiltro === 'Todos'
                ? quejasPendientes
                : quejasPendientes.filter(q => q.tipo === tipoFiltro);

            if (quejasFiltradas.length === 0) {
                quejasLista.innerHTML = `<p class="empty-state">No hay quejas pendientes en esta categoría.</p>`;
                return;
            }

            quejasFiltradas.forEach(queja => {
                const tarjeta = crearTarjetaQueja(queja);
                quejasLista.appendChild(tarjeta);
            });
        }

        /**
         * Crea la tarjeta HTML para una sola queja.
         */
        function crearTarjetaQueja(queja) {
            const tarjeta = document.createElement('div');
            tarjeta.className = 'queja-tarjeta';
            // Guardamos identificadores únicos en el elemento para encontrarlo después
            tarjeta.dataset.id = queja.id;
            tarjeta.dataset.tabla = queja.tabla_origen;

            const fecha = new Date(queja.fecha_creacion);
            const fechaFormateada = fecha.toLocaleString('es-MX', { dateStyle: 'medium', timeStyle: 'short' });

            tarjeta.innerHTML = `
                <div class="tarjeta-header">
                    <span class="tarjeta-folio">${queja.folio}</span>
                    <span class="tarjeta-fecha">${fechaFormateada}</span>
                </div>
                <div class="tarjeta-body">
                    <p><strong>Tipo:</strong> ${queja.tipo}</p>
                    <p><strong>Empleado:</strong> ${queja.numero_empleado}</p>
                    <p><strong>Empresa:</strong> ${queja.empresa}</p>
                </div>`;
            return tarjeta;
        }
        
        /**
         * Abre el modal y lo llena con los detalles de la queja seleccionada.
         */
        function abrirModalDetalles(queja) {
            quejaActual = queja; // Guarda la queja actual
            modalFolio.textContent = `Detalles Folio: ${queja.folio}`;
            
            // Limpia el cuerpo del modal anterior
            modalBody.innerHTML = '';

            // Mapeo de claves a etiquetas legibles
            const etiquetas = {
                numero_empleado: 'No. Empleado', empresa: 'Empresa', ruta: 'Ruta', numero_unidad: 'No. Unidad',
                colonia: 'Colonia', turno: 'Turno', tipo: 'Tipo de Queja', folio: 'Folio',
                detalles_retraso: 'Detalles de Retraso', direccion_subida: 'Dirección de Recolección',
                hora_programada: 'Hora Programada', hora_llegada: 'Hora Real de Llegada',
                metodo_transporte_alterno: 'Transporte Alterno', monto_gastado: 'Monto Gastado',
                hora_llegada_planta: 'Llegada a Planta', nombre_conductor_maltrato: 'Conductor',
                detalles_maltrato: 'Detalles de Mal Trato', detalles_inseguridad: 'Detalles de Inseguridad',
                ubicacion_inseguridad: 'Lugar del Incidente', numero_unidad_malestado: 'No. Unidad (Mal Estado)',
                tipo_falla: 'Tipo de Falla', detalles_malestado: 'Detalles (Mal Estado)', detalles_otro: 'Detalles (Otro)'
            };

            // Crea y añade los detalles al modal
            for(const key in queja) {
                // Muestra solo los campos relevantes y con valor
                if(etiquetas[key] && queja[key] !== null && queja[key] !== '') {
                    let valor = queja[key];
                    // Formatea las fechas para que sean legibles
                    if (['hora_programada', 'hora_llegada', 'hora_llegada_planta'].includes(key)) {
                        valor = new Date(valor).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                    }
                    const item = document.createElement('div');
                    item.className = 'detail-item';
                    item.innerHTML = `<strong>${etiquetas[key]}</strong> <span>${valor}</span>`;
                    
                    // Hace que los campos de detalles largos ocupen todo el ancho
                    if (key.includes('detalles')) {
                        item.classList.add('full-width');
                    }
                    modalBody.appendChild(item);
                }
            }
            detailsModal.classList.add('visible');
        }

        // --- Event Listeners ---

        // Manejador para cambiar de pestaña
        tabsNav.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-btn')) {
                document.querySelector('.tab-btn.active').classList.remove('active');
                e.target.classList.add('active');
                renderQuejas();
            }
        });

        // Manejador para abrir el modal al hacer clic en una tarjeta
        quejasLista.addEventListener('click', (e) => {
            const tarjeta = e.target.closest('.queja-tarjeta');
            if (tarjeta) {
                const quejaId = parseInt(tarjeta.dataset.id);
                const tablaOrigen = tarjeta.dataset.tabla;
                const quejaSeleccionada = todasLasQuejas.find(q => q.id === quejaId && q.tabla_origen === tablaOrigen);
                if (quejaSeleccionada) {
                    abrirModalDetalles(quejaSeleccionada);
                }
            }
        });

        // Manejador para enviar el formulario de resolución
        resolveForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const resolucion = document.getElementById('resolucionText').value;
            if (!resolucion.trim() || !quejaActual) return;
            
            try {
                const response = await fetch('/api/queja/resolver', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: quejaActual.id,
                        tabla_origen: quejaActual.tabla_origen,
                        resolucion: resolucion
                    })
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.error);
                
                detailsModal.classList.remove('visible');
                resolveForm.reset();
                // Vuelve a cargar las quejas para actualizar la lista
                await fetchQuejas();

            } catch (error) {
                alert(`Error al guardar la resolución: ${error.message}`);
            }
        });
        
        modalCloseBtn.addEventListener('click', () => detailsModal.classList.remove('visible'));
        detailsModal.addEventListener('click', (e) => { if(e.target === detailsModal) detailsModal.classList.remove('visible') });

        // Carga inicial de datos
        fetchQuejas();
    });
    </script>
</body>
</html>