<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Quejas</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <meta name="robots" content="noindex, nofollow">

    <style>
        :root {
            --color-primary-dark: #0A1628;
            --color-primary-blue: #1E3A8A;
            --color-accent-blue: #3B82F6;
            --color-light-gray: #F3F4F6;
            --color-text-dark: #1F2937;
            --color-text-medium: #4B5563;
            --color-border: #E5E7EB;
            --color-white: #FFFFFF;
            --color-error: #EF4444;
        }
        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--color-light-gray);
            color: var(--color-text-dark);
            margin: 0;
        }
        .header {
            background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary-blue) 100%);
            color: var(--color-white);
            padding: 20px 40px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 2em;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }
        .queja-seccion {
            background-color: var(--color-white);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            padding: 25px;
        }
        .queja-seccion h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--color-primary-blue);
            margin-top: 0;
            border-bottom: 3px solid var(--color-accent-blue);
            padding-bottom: 10px;
        }
        .quejas-lista {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .queja-tarjeta {
            border: 1px solid var(--color-border);
            border-left: 5px solid var(--color-primary-blue);
            border-radius: 8px;
            padding: 15px;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }
        .queja-tarjeta:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.07);
        }
        .tarjeta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .tarjeta-folio {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.2em;
            color: var(--color-primary-blue);
        }
        .tarjeta-fecha {
            font-size: 0.85em;
            color: var(--color-text-medium);
        }
        .tarjeta-body p {
            margin: 5px 0;
            font-size: 0.95em;
        }
        .tarjeta-body p strong {
            color: var(--color-text-dark);
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-medium);
            font-style: italic;
        }
        #loading-state {
            text-align: center;
            font-size: 1.5em;
            padding: 50px;
            font-family: 'Montserrat', sans-serif;
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>Panel de Quejas Pendientes</h1>
    </header>

    <main class="dashboard-container" id="dashboard">
        </main>
    
    <div id="loading-state">Cargando quejas...</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dashboard = document.getElementById('dashboard');
        const loadingState = document.getElementById('loading-state');
        
        // Define las secciones que queremos mostrar en el panel
        const secciones = {
            'Retraso': { title: 'Retrasos de Unidad', container: null },
            'Mal trato': { title: 'Mal Trato de Conductor', container: null },
            'Inseguridad': { title: 'Conducción Insegura', container: null },
            'Unidad en mal estado': { title: 'Unidades en Mal Estado', container: null },
            'Otro': { title: 'Otras Quejas', container: null }
        };

        /**
         * Crea la estructura de las secciones en el HTML.
         */
        function inicializarSecciones() {
            dashboard.innerHTML = ''; // Limpia el contenedor
            for (const tipo in secciones) {
                const seccionDiv = document.createElement('div');
                seccionDiv.className = 'queja-seccion';
                
                const h2 = document.createElement('h2');
                h2.textContent = secciones[tipo].title;
                
                const listaDiv = document.createElement('div');
                listaDiv.className = 'quejas-lista';
                
                seccionDiv.appendChild(h2);
                seccionDiv.appendChild(listaDiv);
                
                dashboard.appendChild(seccionDiv);
                secciones[tipo].container = listaDiv; // Guarda la referencia al contenedor de la lista
            }
        }
        
        /**
         * Crea la tarjeta HTML para una sola queja.
         * @param {object} queja - El objeto con los datos de la queja.
         * @returns {HTMLElement} El elemento div de la tarjeta.
         */
        function crearTarjetaQueja(queja) {
            const tarjeta = document.createElement('div');
            tarjeta.className = 'queja-tarjeta';

            // Formatea la fecha para que sea más legible
            const fecha = new Date(queja.fecha_creacion);
            const fechaFormateada = fecha.toLocaleString('es-MX', { 
                day: '2-digit', month: 'short', year: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            });

            tarjeta.innerHTML = `
                <div class="tarjeta-header">
                    <span class="tarjeta-folio">${queja.folio}</span>
                    <span class="tarjeta-fecha">${fechaFormateada}</span>
                </div>
                <div class="tarjeta-body">
                    <p><strong>Empleado:</strong> ${queja.numero_empleado}</p>
                    <p><strong>Empresa:</strong> ${queja.empresa}</p>
                    <p><strong>Ruta:</strong> ${queja.ruta}</p>
                </div>
            `;
            // Aquí se podrían añadir más campos o un botón de "Ver detalles" en el futuro
            return tarjeta;
        }

        /**
         * Pide las quejas al servidor y las muestra en el panel.
         */
        async function cargarQuejas() {
            try {
                const response = await fetch('/api/quejas');
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                const todasLasQuejas = await response.json();
                
                // 1. Filtra para obtener solo las quejas pendientes
                const quejasPendientes = todasLasQuejas.filter(q => q.estado_queja === 'Pendiente');
                
                loadingState.style.display = 'none';
                inicializarSecciones();

                if (quejasPendientes.length === 0) {
                    dashboard.innerHTML = '<p class="empty-state">¡Excelente! No hay quejas pendientes por atender.</p>';
                    return;
                }
                
                // 2. Clasifica cada queja en su sección correspondiente
                quejasPendientes.forEach(queja => {
                    if (secciones[queja.tipo] && secciones[queja.tipo].container) {
                        const tarjeta = crearTarjetaQueja(queja);
                        secciones[queja.tipo].container.appendChild(tarjeta);
                    }
                });

                // Añade un mensaje si una sección no tiene quejas pendientes
                for (const tipo in secciones) {
                    if (secciones[tipo].container && secciones[tipo].container.children.length === 0) {
                        secciones[tipo].container.innerHTML = '<p class="empty-state">No hay quejas pendientes en esta categoría.</p>';
                    }
                }

            } catch (error) {
                console.error('Error al cargar las quejas:', error);
                loadingState.textContent = 'Error al cargar las quejas. Revisa la consola.';
                loadingState.style.color = 'var(--color-error)';
            }
        }

        // Inicia la carga de datos cuando la página esté lista
        cargarQuejas();
    });
    </script>
</body>
</html>