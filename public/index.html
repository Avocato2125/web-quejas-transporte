<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quejas | Transporte de Personal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <meta name="description" content="Sistema de quejas para transporte de personal - Envía tu retroalimentación de manera segura">
    <meta name="robots" content="noindex, nofollow">

    <style>
        /* Variables de color */
        :root {
            --color-primary-dark: #0A1628;
            --color-primary-blue: #1E3A8A;
            --color-accent-blue: #3B82F6;
            --color-light-blue: #DBEAFE;
            --color-white: #FFFFFF;
            --color-text-dark: #1F2937;
            --color-text-light: #F8FAFC;
            --color-border: #E5E7EB;
            --color-shadow: rgba(30, 58, 138, 0.15);
            --color-hover-blue: #2563EB;
            --color-success: #10B981;
            --color-error: #EF4444;
            --color-warning: #F59E0B;
            --color-info: #6366F1;
        }

        /* Estilos Generales y del Body */
        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary-blue) 100%);
            color: var(--color-text-light);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            line-height: 1.6;
        }

        /* Contenedor principal del formulario */
        .form-container {
            background: var(--color-white);
            border-radius: 20px;
            box-shadow: 0 25px 50px var(--color-shadow);
            padding: 50px;
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            animation: fadeInScale 0.8s ease-out;
        }

        /* Barra superior de acento */
        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--color-accent-blue), var(--color-primary-blue), var(--color-accent-blue));
            z-index: 1;
        }

        /* Animación de entrada para el formulario */
        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Títulos */
        h2 {
            font-family: 'Montserrat', sans-serif;
            text-align: center;
            color: var(--color-primary-blue);
            margin-bottom: 40px;
            font-size: 2.8em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2.5px;
            position: relative;
            padding-bottom: 15px;
        }

        /* Línea decorativa bajo el título */
        h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 4px;
            background: linear-gradient(90deg, var(--color-accent-blue), var(--color-primary-blue));
            border-radius: 2px;
        }

        h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--color-primary-blue);
            margin-top: 35px;
            margin-bottom: 20px;
            padding: 15px 25px;
            background: var(--color-light-blue);
            border-radius: 10px;
            font-size: 1.4em;
            font-weight: 600;
            letter-spacing: 0.7px;
            border-left: 6px solid var(--color-accent-blue);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* Estilos para Etiquetas y Campos de Entrada */
        label {
            display: block;
            margin-bottom: 10px;
            color: var(--color-text-dark);
            font-weight: 700;
            font-size: 1.05em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* FIX: Selector corregido para aplicar el asterisco solo a campos requeridos */
        .form-group.is-required label::after {
            content: ' *';
            color: var(--color-error);
            font-weight: bold;
        }

        input[type="text"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 16px;
            margin-bottom: 25px;
            border: 2px solid var(--color-border);
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 1.05em;
            color: var(--color-text-dark);
            background-color: var(--color-white);
            transition: all 0.3s ease;
            font-family: 'Lato', sans-serif;
        }

        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%233B82F6" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 18px center;
            background-size: 22px;
            cursor: pointer;
        }

        input[type="text"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--color-accent-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            outline: none;
            transform: translateY(-3px);
            background-color: var(--color-white);
        }
        
        select:invalid {
            color: #9CA3AF;
        }
        select option {
            color: var(--color-text-dark);
        }
        select option[value=""] {
            color: #9CA3AF;
        }

        input[type="text"]::placeholder,
        textarea::placeholder {
            color: #9CA3AF;
            font-style: italic;
        }

        button[type="submit"] {
            background: linear-gradient(135deg, var(--color-accent-blue), var(--color-primary-blue));
            color: var(--color-white);
            padding: 18px 40px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.3em;
            font-weight: 700;
            width: 100%;
            transition: all 0.3s ease;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            position: relative;
            overflow: hidden;
        }

        button[type="submit"]:hover {
            transform: translateY(-5px);
            box-shadow: 0 18px 40px rgba(59, 130, 246, 0.5);
            background: linear-gradient(135deg, var(--color-hover-blue), var(--color-primary-blue));
        }

        button[type="submit"]:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        button[type="submit"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s ease-out;
        }

        button[type="submit"]:hover::before {
            left: 100%;
        }

        button[type="submit"]:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Estilos para las Secciones Específicas de Queja */
        .queja-especifica {
            display: none;
            border: 2px solid var(--color-light-blue);
            background: linear-gradient(135deg, var(--color-white) 0%, var(--color-light-blue) 100%);
            padding: 35px;
            margin-top: 35px;
            margin-bottom: 35px;
            border-radius: 15px;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.15);
            position: relative;
            overflow: hidden;
            animation: slideInFromLeft 0.6s ease-out;
        }

        .queja-especifica::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--color-accent-blue), var(--color-primary-blue));
            border-radius: 15px 15px 0 0;
        }

        @keyframes slideInFromLeft {
            from { opacity: 0; transform: translateX(-40px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        /* Overlay de carga */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
            font-family: 'Montserrat', sans-serif;
            color: var(--color-primary-blue);
            font-size: 1.5em;
            font-weight: 600;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid var(--color-light-blue);
            border-top: 6px solid var(--color-accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos de notificación flotante */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            pointer-events: none;
        }

        .notification {
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            pointer-events: all;
            cursor: pointer;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success { background: var(--color-success); }
        .notification.error { background: var(--color-error); }
        .notification.info { background: var(--color-info); }
        .notification.warning { background: var(--color-warning); color: var(--color-text-dark); }

        /* Validación visual y mensajes de error por campo */
        .form-group.error input,
        .form-group.error textarea,
        .form-group.error select {
            border-color: var(--color-error);
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15);
        }

        .form-group.success input,
        .form-group.success textarea,
        .form-group.success select {
            border-color: var(--color-success);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
        }

        .error-message {
            color: var(--color-error);
            font-size: 0.875em;
            margin-top: -15px;
            margin-bottom: 15px;
            display: none;
            font-weight: 600;
        }
        
        /* Estilos para el estado de la ubicación */
        #ubicacion-status {
            text-align: center;
            min-height: 30px;
            margin-bottom: 20px;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--color-text-dark);
            background-color: var(--color-border);
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        #ubicacion-status.show {
            opacity: 1;
            pointer-events: all;
        }

        #ubicacion-status.loading {
            background-color: rgba(99, 102, 241, 0.15);
            color: var(--color-info);
            border: 1px solid var(--color-info);
        }
        #ubicacion-status.success {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--color-success);
            border: 1px solid var(--color-success);
        }
        #ubicacion-status.error {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--color-error);
            border: 1px solid var(--color-error);
        }
        #ubicacion-status.denied {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
            border: 1px solid var(--color-warning);
            font-weight: bold;
        }

        /* Responsividad */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .form-container { padding: 30px 25px; margin: 10px; border-radius: 15px; }
            h2 { font-size: 2.2em; margin-bottom: 30px; letter-spacing: 2px; }
            h2::after { width: 80px; }
            h3 { font-size: 1.2em; padding: 12px 15px; }
            label { font-size: 0.95em; }
            input, select, textarea { padding: 14px; font-size: 16px; }
            button[type="submit"] { padding: 16px 30px; font-size: 1.1em; }
            .queja-especifica { padding: 25px 20px; }
            #notification-container {
                right: 10px;
                left: 10px;
                max-width: none;
                top: 10px;
            }
        }

        @media (max-width: 480px) {
            h2 { font-size: 1.8em; letter-spacing: 1.5px; }
            .form-container { padding: 25px 20px; }
            button[type="submit"] { font-size: 1em; padding: 15px 25px; }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <span id="loading-text">Enviando queja...</span>
        </div>

        <h2>Quejas Transporte de Personal</h2>

        <form id="form-queja">
            <div class="form-group">
                <label for="numero_empleado">Número de Empleado:</label>
                <input type="text" id="numero_empleado" name="numero_empleado" placeholder="Ej: 123456" required minlength="4" maxlength="10">
                <div class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="empresa">Empresa:</label>
                <select name="empresa" id="empresa" required>
                    <option value="" disabled selected>Selecciona una empresa</option>
                    <option value="abc">ABC Technologies</option>
                    <option value="leoch">Leoch Battery</option>
                    <option value="gerber">Gerber</option>
                    <option value="phillips">Phillips</option>
                </select>
                <div class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="ruta">Ruta:</label>
                <input type="text" id="ruta" name="ruta" placeholder="Ej: Ruta 15, Circuito Norte" required maxlength="100">
                <div class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="numero_unidad">Número de Unidad (Opcional):</label>
                <input type="text" id="numero_unidad" name="numero_unidad" placeholder="Ej: 123, ECO-456" maxlength="50">
                <div class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="colonia">Colonia:</label>
                <input type="text" id="colonia" name="colonia" placeholder="Ej: Centro, Las Flores" required maxlength="100">
                <div class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="turno">Turno:</label>
                <select name="turno" id="turno" required>
                    <option value="" disabled selected>Selecciona tu turno</option>
                    <option value="Primero">Primero</option>
                    <option value="Segundo">Segundo</option>
                    <option value="Tercero">Tercero</option>
                    <option value="Mixto">Mixto</option>
                </select>
                <div class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="tipo">Tipo de queja:</label>
                <select name="tipo" id="tipo" required>
                    <option value="" disabled selected>Selecciona el tipo de queja</option>
                    <option value="Retraso">Retraso de Unidad</option>
                    <option value="Mal trato">Mal Trato / Mala Actitud del Conductor</option>
                    <option value="Inseguridad">Inseguridad / Conducción Peligrosa</option>
                    <option value="Unidad en mal estado">Unidad en Mal Estado</option>
                    <option value="Otro">Otro (especificar)</option>
                </select>
                <div class="error-message"></div>
            </div>

            <div id="seccion-Retraso" class="queja-especifica">
                <h3>Detalles de Retraso de Unidad</h3>
                <div class="form-group">
                    <label for="direccion_subida">Dirección de Recolección:</label>
                    <input type="text" id="direccion_subida" name="direccion_subida" placeholder="Ej: Av. Siempre Viva 123, Centro" data-required="true" maxlength="200">
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="hora_programada">Hora Programada:</label>
                    <input type="time" id="hora_programada" name="hora_programada" data-required="true">
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="hora_llegada">Hora Real de Llegada:</label>
                    <input type="time" id="hora_llegada" name="hora_llegada" data-required="true">
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="detalles_retraso">Describe lo ocurrido:</label>
                    <textarea id="detalles_retraso" name="detalles_retraso" rows="3" placeholder="Ej: La unidad llegó 20 minutos tarde sin aviso." data-required="true" maxlength="500"></textarea>
                    <div class="error-message"></div>
                </div>
            </div>

            <div id="seccion-Mal_trato" class="queja-especifica">
                <h3>Detalles de Mal Trato / Mala Actitud</h3>
                <div class="form-group">
                    <label for="nombre_conductor_maltrato">Nombre/Unidad del conductor (Opcional):</label>
                    <input type="text" id="nombre_conductor_maltrato" name="nombre_conductor_maltrato" placeholder="Ej: Conductor Juan Pérez / Unidad #456" maxlength="100">
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="detalles_maltrato">Describe lo ocurrido:</label>
                    <textarea id="detalles_maltrato" name="detalles_maltrato" rows="4" placeholder="Ej: El conductor usó lenguaje inapropiado..." data-required="true" maxlength="1000"></textarea>
                    <div class="error-message"></div>
                </div>
            </div>

            <div id="seccion-Inseguridad" class="queja-especifica">
                <h3>Detalles de Inseguridad / Conducción Peligrosa</h3>
                <div class="form-group">
                    <label for="detalles_inseguridad">Describe la situación:</label>
                    <textarea id="detalles_inseguridad" name="detalles_inseguridad" rows="4" placeholder="Ej: El conductor excedía el límite de velocidad..." data-required="true" maxlength="1000"></textarea>
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="ubicacion_inseguridad">Ubicación del incidente (Opcional):</label>
                    <input type="text" id="ubicacion_inseguridad" name="ubicacion_inseguridad" placeholder="Ej: En la intersección de Av. Central y Calle Juárez" maxlength="200">
                    <div class="error-message"></div>
                </div>
            </div>

            <div id="seccion-Unidad_en_mal_estado" class="queja-especifica">
                <h3>Detalles de Unidad en Mal Estado</h3>
                <div class="form-group">
                    <label for="numero_unidad_malestado">Número de Unidad (Opcional):</label>
                    <input type="text" id="numero_unidad_malestado" name="numero_unidad_malestado" placeholder="Ej: Unidad 789" maxlength="50">
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="tipo_falla">Tipo de falla o daño:</label>
                    <input type="text" id="tipo_falla" name="tipo_falla" placeholder="Ej: Asientos rotos, Aire acondicionado no funciona" data-required="true" maxlength="200">
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="detalles_malestado">Describe el estado de la unidad:</label>
                    <textarea id="detalles_malestado" name="detalles_malestado" rows="4" placeholder="Ej: La unidad olía a gasolina, los cinturones no servían..." data-required="true" maxlength="1000"></textarea>
                    <div class="error-message"></div>
                </div>
            </div>

            <div id="seccion-Otro" class="queja-especifica">
                <h3>Otros Detalles</h3>
                <div class="form-group">
                    <label for="detalles_otro">Describe tu queja:</label>
                    <textarea id="detalles_otro" name="detalles_otro" rows="5" data-required="true" placeholder="Por favor, sé lo más específico posible." maxlength="1000"></textarea>
                    <div class="error-message"></div>
                </div>
            </div>

            <input type="hidden" id="latitud" name="latitud">
            <input type="hidden" id="longitud" name="longitud">
            
            <div class="form-group">
                <div id="ubicacion-status"></div>
            </div>

            <button type="submit" id="submitBtn">Enviar Queja</button>
        </form>
    </div>

    <div id="notification-container"></div>

    <script>
        // FIX: Todo el script está encapsulado para proteger el ámbito global.
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONSTANTES Y SELECTORES DEL DOM ---
            const formQueja = document.getElementById('form-queja');
            const tipoQuejaSelect = document.getElementById('tipo');
            const seccionesEspecificas = document.querySelectorAll('.queja-especifica');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const submitBtn = document.getElementById('submitBtn');
            const notificationContainer = document.getElementById('notification-container');
            const latitudInput = document.getElementById('latitud');
            const longitudInput = document.getElementById('longitud');
            const ubicacionStatus = document.getElementById('ubicacion-status');
            
            const SESSION_STORAGE_KEY = 'queja-progress';
            let isSubmitting = false;

            // --- FUNCIONES ---

            /**
             * Muestra una notificación flotante.
             * @param {string} message El mensaje a mostrar.
             * @param {'success'|'error'|'info'|'warning'} type El tipo de notificación.
             * @param {number} duration Duración en milisegundos.
             */
            function showNotification(message, type = 'success', duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;

                notificationContainer.appendChild(notification);
                setTimeout(() => notification.classList.add('show'), 100);

                const removeNotification = () => {
                    notification.classList.remove('show');
                    notification.addEventListener('transitionend', () => notification.remove(), { once: true });
                };

                const timer = setTimeout(removeNotification, duration);
                notification.addEventListener('click', () => {
                    clearTimeout(timer);
                    removeNotification();
                });
            }

            /**
             * Valida un campo individual y actualiza la UI.
             * @param {HTMLElement} field El campo del formulario a validar.
             * @returns {boolean} True si el campo es válido, false en caso contrario.
             */
            function validateField(field) {
                const formGroup = field.closest('.form-group');
                if (!formGroup) return true;

                const errorMessage = formGroup.querySelector('.error-message');
                let isValid = true;
                let message = '';
                
                // FIX: Lógica para añadir una clase al contenedor si el campo es requerido.
                if (field.hasAttribute('required')) {
                    formGroup.classList.add('is-required');
                } else {
                    formGroup.classList.remove('is-required');
                }

                formGroup.classList.remove('error', 'success');
                if (errorMessage) errorMessage.style.display = 'none';

                if (field.hasAttribute('required') && !field.value.trim()) {
                    isValid = false;
                    message = 'Este campo es requerido.';
                } else if (field.type === 'text' || field.tagName === 'TEXTAREA') {
                    const minLength = parseInt(field.getAttribute('minlength'), 10) || 0;
                    if (field.value.trim().length > 0 && field.value.trim().length < minLength) {
                        isValid = false;
                        message = `Debe tener al menos ${minLength} caracteres.`;
                    }
                }

                if (!isValid) {
                    formGroup.classList.add('error');
                    if (errorMessage) {
                        errorMessage.textContent = message;
                        errorMessage.style.display = 'block';
                    }
                } else if (field.value.trim()) {
                    formGroup.classList.add('success');
                }
                
                return isValid;
            }

            /**
             * Escapa caracteres HTML para prevenir XSS.
             * @param {string} value El texto a sanitizar.
             * @returns {string} El texto sanitizado.
             */
            function sanitizeInput(value) {
                if (typeof value !== 'string') return value;
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#x27;',
                    '/': '&#x2F;',
                };
                const reg = /[&<>"'/]/ig;
                // FIX: La función ahora reemplaza solo los caracteres peligrosos y no elimina el resto.
                return value.trim().replace(reg, (match) => map[match]);
            }

            /**
             * Muestra la sección de queja correcta y gestiona los campos requeridos.
             */
            function mostrarSeccionQueja() {
                const tipoSeleccionado = tipoQuejaSelect.value;

                seccionesEspecificas.forEach(seccion => {
                    seccion.style.display = 'none';
                    seccion.querySelectorAll('input, textarea').forEach(field => {
                        field.removeAttribute('required');
                        // Limpiar clases de validación al ocultar
                        const formGroup = field.closest('.form-group');
                        if(formGroup) formGroup.classList.remove('error', 'success', 'is-required');
                    });
                });

                if (tipoSeleccionado) {
                    const idSeccion = 'seccion-' + tipoSeleccionado.replace(/ /g, '_');
                    const seccionAMostrar = document.getElementById(idSeccion);
                    if (seccionAMostrar) {
                        seccionAMostrar.style.display = 'block';
                        seccionAMostrar.querySelectorAll('[data-required="true"]').forEach(field => {
                            field.setAttribute('required', 'required');
                            validateField(field); // Re-validar para mostrar el estado
                        });
                    }
                }
            }
            
            /**
             * Valida el formulario completo antes del envío.
             * @returns {boolean} True si todo el formulario es válido.
             */
            function validateCompleteForm() {
                let isFormValid = true;
                formQueja.querySelectorAll('input[required], select[required], textarea[required]').forEach(field => {
                    // Solo validar campos que son visibles
                    if (field.offsetParent !== null) {
                        if (!validateField(field)) {
                            isFormValid = false;
                        }
                    }
                });
                return isFormValid;
            }

            /**
             * Intenta obtener la geolocalización del usuario.
             */
            function obtenerUbicacion() {
                if (!navigator.geolocation) {
                    ubicacionStatus.textContent = 'Tu navegador no soporta la geolocalización.';
                    ubicacionStatus.className = 'ubicacion-status error show';
                    return;
                }

                ubicacionStatus.textContent = 'Obteniendo tu ubicación...';
                ubicacionStatus.className = 'ubicacion-status loading show';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        latitudInput.value = position.coords.latitude;
                        longitudInput.value = position.coords.longitude;
                        ubicacionStatus.textContent = 'Ubicación obtenida.';
                        ubicacionStatus.className = 'ubicacion-status success show';
                        showNotification('Ubicación obtenida con éxito.', 'success', 3000);
                    },
                    (error) => {
                        latitudInput.value = '';
                        longitudInput.value = '';
                        let errorMessage = 'No se pudo obtener la ubicación.';
                        let statusClass = 'error';
                        let notificationType = 'error';

                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = 'Permiso de ubicación denegado.';
                            statusClass = 'denied';
                            notificationType = 'warning';
                        }
                        
                        ubicacionStatus.textContent = errorMessage;
                        ubicacionStatus.className = `ubicacion-status ${statusClass} show`;
                        showNotification(errorMessage + ' La queja se enviará sin geolocalización.', notificationType, 6000);
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            }
            
            /**
             * Guarda el progreso del formulario en sessionStorage.
             */
            function saveProgress() {
                const formData = new FormData(formQueja);
                const data = Object.fromEntries(formData.entries());
                sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(data));
            }

            /**
             * Carga el progreso del formulario desde sessionStorage.
             */
            function loadProgress() {
                const saved = sessionStorage.getItem(SESSION_STORAGE_KEY);
                if (!saved) return;
                
                try {
                    const data = JSON.parse(saved);
                    Object.entries(data).forEach(([key, value]) => {
                        const field = formQueja.elements[key];
                        if (field) {
                            if (field.type === 'radio' || field.type === 'checkbox') {
                                field.checked = field.value === value;
                            } else {
                                field.value = value;
                            }
                        }
                    });
                    mostrarSeccionQueja();
                    formQueja.querySelectorAll('input, select, textarea').forEach(field => validateField(field));
                    showNotification('Progreso de la queja cargado.', 'info', 3000);
                } catch (e) {
                    console.error('No se pudo cargar el progreso guardado:', e);
                    sessionStorage.removeItem(SESSION_STORAGE_KEY);
                }
            }

            // --- MANEJADORES DE EVENTOS Y EJECUCIÓN INICIAL ---

            // Añadir validación en tiempo real a cada campo
            formQueja.querySelectorAll('input, select, textarea').forEach(field => {
                field.addEventListener('input', () => validateField(field));
                // También validar al perder el foco para una UX más clara
                field.addEventListener('blur', () => validateField(field));
            });

            // Cambiar la sección de queja dinámicamente
            tipoQuejaSelect.addEventListener('change', mostrarSeccionQueja);

            // Manejar el envío del formulario
            formQueja.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (isSubmitting) {
                    showNotification('La queja ya se está enviando. Por favor, espera.', 'info');
                    return;
                }
                
                if (!validateCompleteForm()) {
                    showNotification('Por favor, corrige los errores en el formulario.', 'error');
                    // Enfocar el primer campo con error
                    const firstErrorField = formQueja.querySelector('.error input, .error select, .error textarea');
                    if(firstErrorField) firstErrorField.focus();
                    return;
                }

                isSubmitting = true;
                loadingOverlay.style.display = 'flex';
                submitBtn.disabled = true;

                const formData = new FormData(e.target);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = sanitizeInput(value);
                }

                try {
                    // Simulación de envío al backend
                    console.log("Enviando al backend:", JSON.stringify(data, null, 2));
                    const res = await fetch('/enviar-queja', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const responseData = await res.json();

                    if (res.ok && responseData.success) {
                        showNotification('¡Queja enviada con éxito! Gracias.', 'success');
                        formQueja.reset();
                        // FIX: La limpieza del sessionStorage ahora ocurre solo tras un envío exitoso.
                        sessionStorage.removeItem(SESSION_STORAGE_KEY);
                        mostrarSeccionQueja();
                        formQueja.querySelectorAll('.form-group').forEach(group => {
                            group.classList.remove('error', 'success', 'is-required');
                        });
                    } else {
                        showNotification(responseData.error || 'Error desconocido al enviar la queja.', 'error');
                    }
                } catch (error) {
                    console.error('Error de red al enviar la queja:', error);
                    showNotification('Hubo un problema de conexión. Inténtalo de nuevo.', 'error');
                } finally {
                    isSubmitting = false;
                    loadingOverlay.style.display = 'none';
                    submitBtn.disabled = false;
                }
            });

            // --- INICIALIZACIÓN ---
            loadProgress();
            obtenerUbicacion();
            // Guardar progreso cada 30 segundos
            setInterval(saveProgress, 30000);
        });
    </script>
</body>
</html>